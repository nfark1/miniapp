<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>–ê–¥–º–∏–Ω ‚Äî –ê–≤—Ç–æ—Ä—ã–Ω–æ–∫ (–ª–æ–∫–∞–ª—å–Ω–æ)</title>
<style>
  :root{--bg:#0f0f0f;--fg:#fff;--muted:#9aa3ad;--accent:#2d82ff}
  *{box-sizing:border-box;font-family:-apple-system,system-ui,Roboto}
  body{margin:0;background:var(--bg);color:var(--fg)}
  a{text-decoration:none;color:inherit}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #1f1f1f}
  .wrap{padding:12px 14px;max-width:1100px;margin:0 auto}
  .btn{background:#2d82ff;color:#fff;border:1px solid #2d82ff;border-radius:10px;padding:8px 10px;cursor:pointer}
  .btn.ghost{background:#171717;color:#ddd;border-color:#242424}
  .btn.danger{background:#3a1111;border-color:#5a1a1a}
  .btn[disabled]{opacity:.6;cursor:wait}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:10px;border-bottom:1px solid #1f1f1f;vertical-align:top}
  th{color:#9aa3ad;text-align:left;font-weight:600}
  .status{font-weight:700}
  .thumb{width:120px;height:80px;background:#1a1a1a;background-size:cover;background-position:center;border-radius:8px}
  .filters{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
  select, input{background:#171717;border:1px solid #242424;color:#fff;border-radius:10px;padding:8px}
  .muted{color:#9aa3ad}

  /* modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:999}
  .modal .card{background:#121212;border:1px solid #1f1f1f;border-radius:12px;padding:14px;max-width:900px;width:100%}
  .editor .grid{display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:10px}
  .editor label{display:block;color:#9aa3ad;margin:6px 0 4px;font-size:13px}
  .editor input,.editor textarea{width:100%;background:#171717;border:1px solid #242424;color:#fff;border-radius:10px;padding:8px}
  .editor textarea{height:90px;resize:vertical}
  .editor .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .switch{display:inline-flex;gap:6px;align-items:center}
  .switch input{width:auto}

  /* —Ñ–æ—Ç–æ-–≥–∞–ª–µ—Ä–µ—è –≤ –º–æ–¥–∞–ª–∫–µ */
  .pv{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .thumb-wrap{position:relative}
  .thumb-img{width:100px;height:72px;object-fit:cover;border-radius:8px;border:1px solid #262626;display:block}
  .thumb-del{position:absolute;top:-6px;right:-6px;width:22px;height:22px;border-radius:50%;
             border:1px solid #333;background:#1f1f1f;color:#fff;cursor:pointer;line-height:18px}
</style>

<header>
  <div style="font-weight:700">–ê–¥–º–∏–Ω ‚Äî –ê–≤—Ç–æ—Ä—ã–Ω–æ–∫</div>
  <div style="display:flex;gap:8px;align-items:center">
    <a class="btn ghost" href="/webapp/">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
  </div>
</header>

<div class="wrap">
  <div id="msg" class="muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>

  <div class="filters">
    <label>–°—Ç–∞—Ç—É—Å:</label>
    <select id="f_status">
      <option value="">–õ—é–±–æ–π</option>
      <option value="PENDING">PENDING</option>
      <option value="APPROVED">APPROVED</option>
      <option value="REJECTED">REJECTED</option>
    </select>
    <button id="refresh" class="btn">–û–±–Ω–æ–≤–∏—Ç—å</button>
  </div>

  <table id="tbl" style="display:none">
    <thead>
      <tr>
        <th>ID</th>
        <th>–§–æ—Ç–æ</th>
        <th>–ê–≤—Ç–æ</th>
        <th>–¶–µ–Ω–∞ / –†–∞–π–æ–Ω</th>
        <th>–°—Ç–∞—Ç—É—Å</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<!-- MODAL: —Ä–µ–¥–∞–∫—Ç–æ—Ä -->
<div class="modal" id="editModal">
  <div class="card editor">
    <h3 style="margin:4px 0 10px">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h3>
    <div class="grid">
      <div>
        <label>–ú–∞—Ä–∫–∞</label>
        <input id="e_brand" placeholder="Lada / Toyota / BMW">
      </div>
      <div>
        <label>–ú–æ–¥–µ–ª—å</label>
        <input id="e_model" placeholder="Granta / Camry / 320i">
      </div>
      <div>
        <label>–ì–æ–¥</label>
        <input id="e_year" type="number" min="1950" max="2100">
      </div>
      <div>
        <label>–¶–µ–Ω–∞, ‚ÇΩ</label>
        <input id="e_price" type="number" min="0">
      </div>
      <div style="grid-column:1 / -1">
        <label>–†–∞–π–æ–Ω</label>
        <input id="e_district" placeholder="–ü–µ—Ä–º—å, –°–≤–µ—Ä–¥–ª–æ–≤—Å–∫–∏–π">
      </div>
      <div style="grid-column:1 / -1">
        <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
        <textarea id="e_desc" placeholder="–ö–æ—Ä–æ—Ç–∫–æ –ø—Ä–æ –∞–≤—Ç–æ"></textarea>
      </div>

      <!-- —Ç–µ–∫—É—â–∏–µ —Ñ–æ—Ç–æ + —É–¥–∞–ª–µ–Ω–∏–µ -->
      <div style="grid-column:1 / -1">
        <label>–¢–µ–∫—É—â–∏–µ —Ñ–æ—Ç–æ (√ó ‚Äî —É–¥–∞–ª–∏—Ç—å)</label>
        <div id="e_photos_wrap" class="pv"></div>
      </div>

      <!-- –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤ -->
      <div style="grid-column:1 / -1">
        <label>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ñ–æ—Ç–æ</label>
        <input id="e_files" type="file" multiple accept="image/*">
        <div id="e_new_wrap" class="pv"></div>
      </div>

      <div class="switch" style="grid-column:1 / -1">
        <input id="e_top" type="checkbox">
        <label for="e_top">–¢–û–ü</label>
      </div>
    </div>
    <div class="row" style="margin-top:12px;justify-content:flex-end">
      <button id="e_close" class="btn ghost" type="button">–ó–∞–∫—Ä—ã—Ç—å</button>
      <button id="e_save" class="btn" type="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<script>
  const msg = document.getElementById("msg");
  const tbl = document.getElementById("tbl");
  const tbody = document.getElementById("tbody");
  const fStatus = document.getElementById("f_status");
  const btnRefresh = document.getElementById("refresh");

  // —ç–ª–µ–º–µ–Ω—Ç—ã –º–æ–¥–∞–ª–∫–∏
  const modal       = document.getElementById("editModal");
  const e_brand     = document.getElementById("e_brand");
  const e_model     = document.getElementById("e_model");
  const e_year      = document.getElementById("e_year");
  const e_price     = document.getElementById("e_price");
  const e_district  = document.getElementById("e_district");
  const e_desc      = document.getElementById("e_desc");
  const e_top       = document.getElementById("e_top");
  const btnSave     = document.getElementById("e_save");
  const btnClose    = document.getElementById("e_close");

  const photosWrap  = document.getElementById("e_photos_wrap"); // —Ç–µ–∫—É—â–∏–µ —Ñ–æ—Ç–æ
  const eFiles      = document.getElementById("e_files");        // –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã
  const newWrap     = document.getElementById("e_new_wrap");     // –ø—Ä–µ–≤—å—é –Ω–æ–≤—ã—Ö

  let currItems = [];
  let editId = null;

  let existingPhotos = []; // —Å—Ç—Ä–æ–∫–∏-–ø—É—Ç–∏ /uploads/...
  let newFiles = [];       // File[]

  // --- –ù–æ–≤—ã–π –∫–æ–¥: —á–∏—Ç–∞–µ–º ?open=ID –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
  const urlOpenId = Number(new URLSearchParams(location.search).get("open") || 0);
  let openedByParam = false;

  async function apiMe(){
    const r = await fetch("/api/me", {credentials:"include"});
    if(!r.ok) return null;
    return await r.json();
  }
  async function apiAdminList(status=""){
    let url = "/api/admin/listings";
    status = (status || "").trim();
    if(status) url += "?status=" + encodeURIComponent(status);
    const r = await fetch(url, {credentials:"include"});
    if(!r.ok) throw new Error("forbidden");
    return await r.json();
  }
  async function postJSON(url, data){
    const r = await fetch(url, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      credentials:"include",
      body: JSON.stringify(data||{})
    });
    const text = await r.text();
    let json = null; try{ json = JSON.parse(text); }catch(_){}
    return { ok:r.ok, status:r.status, json, text };
  }
  function fmtPrice(n){
    if(typeof n !== "number") return n||"";
    return n.toLocaleString("ru-RU") + " ‚ÇΩ";
  }

  function renderRows(items){
    tbody.innerHTML = "";
    if(!items || !items.length){
      tbody.innerHTML = `<tr><td colspan="6" style="color:#9aa3ad">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>`;
      return;
    }
    for (const it of items){
      const first = (it.photos && it.photos[0]) ? it.photos[0] : "";
      const link  = `/webapp/item/${it.id}`;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${it.id}</td>
        <td>
          <a href="${link}" target="_blank" rel="noopener">
            <div class="thumb" style="${first ? `background-image:url('${first}')` : ``}"></div>
          </a>
        </td>
        <td class="cell-car">
          <div style="font-weight:700" class="title">
            <a href="${link}" target="_blank" rel="noopener">${it.brand} ${it.model}</a>
          </div>
          <div class="year">${it.year}</div>
          <div class="desc" style="color:#9aa3ad;max-width:280px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${it.desc||""}</div>
        </td>
        <td class="cell-price">
          <div class="price">${fmtPrice(it.price_rub)}</div>
          <div class="district" style="color:#9aa3ad">${it.district||""}</div>
        </td>
        <td class="status">${it.status}</td>
        <td class="actions">
          <button class="btn" data-act="approve" data-id="${it.id}">–û–¥–æ–±—Ä–∏—Ç—å</button>
          <button class="btn ghost" data-act="reject" data-id="${it.id}">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
          <button class="btn ghost" data-act="edit" data-id="${it.id}">‚úè –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          <button class="btn ghost" data-act="delete" data-id="${it.id}">üóë –£–¥–∞–ª–∏—Ç—å</button>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  async function load(){
    msg.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";
    tbl.style.display = "none";
    try{
      const me = await apiMe();
      if(!me || !me.is_admin){
        msg.textContent = "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω. –ó–∞–ª–æ–≥–∏–Ω—å—Å—è dev-–ª–æ–≥–∏–Ω–æ–º –∫–∞–∫ –∞–¥–º–∏–Ω –Ω–∞ –≥–ª–∞–≤–Ω–æ–π.";
        return;
      }
      const data = await apiAdminList((fStatus.value||"").trim());
      currItems = data.items || [];
      renderRows(currItems);
      msg.textContent = "–ì–æ—Ç–æ–≤–æ";
      tbl.style.display = "table";

      // --- –ù–æ–≤—ã–π –∫–æ–¥: –æ—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É, –µ—Å–ª–∏ –µ—Å—Ç—å open=ID –∏ –µ—â—ë –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–ª–∏
      if (urlOpenId && !openedByParam){
        const exists = currItems.some(x => x.id === urlOpenId);
        if (exists){
          openedByParam = true;
          openEdit(urlOpenId);
        }
      }
    }catch(e){
      console.error(e);
      msg.textContent = "–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∏–ª–∏ —Å–µ—Ç–∏";
    }
  }

  function renderExistingPhotos(){
    photosWrap.innerHTML = "";
    existingPhotos.forEach((url, idx)=>{
      const wrap = document.createElement("div");
      wrap.className = "thumb-wrap";
      const img = document.createElement("img");
      img.src = url; img.className = "thumb-img";
      const del = document.createElement("button");
      del.type = "button"; del.className = "thumb-del"; del.textContent = "√ó";
      del.title = "–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ";
      del.onclick = ()=>{
        existingPhotos.splice(idx, 1);
        renderExistingPhotos();
      };
      wrap.appendChild(img);
      wrap.appendChild(del);
      photosWrap.appendChild(wrap);
    });
  }
  function renderNewFiles(){
    newWrap.innerHTML = "";
    newFiles.forEach((file, idx)=>{
      const obj = URL.createObjectURL(file);
      const wrap = document.createElement("div");
      wrap.className = "thumb-wrap";
      const img = document.createElement("img");
      img.src = obj; img.className = "thumb-img";
      img.onload = ()=> URL.revokeObjectURL(obj);
      const del = document.createElement("button");
      del.type = "button"; del.className = "thumb-del"; del.textContent = "√ó";
      del.title = "–£–±—Ä–∞—Ç—å –Ω–æ–≤—ã–π —Ñ–∞–π–ª";
      del.onclick = ()=>{
        newFiles.splice(idx, 1);
        renderNewFiles();
      };
      wrap.appendChild(img);
      wrap.appendChild(del);
      newWrap.appendChild(wrap);
    });
  }

  function openEdit(id){
    const it = currItems.find(x => x.id === id);
    if(!it){ alert("–û–±—ä—è–≤–ª–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"); return; }
    editId = id;

    e_brand.value    = it.brand || "";
    e_model.value    = it.model || "";
    e_year.value     = it.year  ?? "";
    e_price.value    = it.price_rub ?? "";
    e_district.value = it.district || "";
    e_desc.value     = it.desc || "";
    e_top.checked    = !!it.top;

    existingPhotos = Array.isArray(it.photos) ? [...it.photos] : [];
    newFiles = [];
    renderExistingPhotos();
    renderNewFiles();

    eFiles.value = "";
    modal.style.display = "flex";
  }
  function closeEdit(){
    modal.style.display = "none";
    editId = null;
  }

  // –ö–ª–∏–∫–∏ –ø–æ —Ç–∞–±–ª–∏—Ü–µ
  tbody.addEventListener("click", async (e)=>{
    const btn = e.target.closest("button[data-act]");
    if(!btn) return;
    const id = +btn.dataset.id;
    const act = btn.dataset.act;

    if (act === "edit"){ openEdit(id); return; }

    if (act === "delete"){
      if(!confirm("–£–¥–∞–ª–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ #" + id + "?")) return;
      btn.disabled = true; const prev = btn.textContent; btn.textContent = "‚Ä¶";
      const res = await postJSON("/api/admin/delete", { id });
      if(!res.ok){ alert("–û—à–∏–±–∫–∞: " + res.status + " " + (res.text||"")); btn.disabled=false; btn.textContent=prev; return; }
      await load();
      return;
    }

    // approve / reject
    btn.disabled = true; const prevText = btn.textContent; btn.textContent = "‚Ä¶";
    const url = act === "approve" ? "/api/admin/approve" : "/api/admin/reject";
    const res = await postJSON(url, { id });
    if(!res.ok){
      alert("–û—à–∏–±–∫–∞: " + res.status + " " + (res.text||""));
      btn.disabled = false; btn.textContent = prevText;
      return;
    }
    if(res.json && res.json.item){
      const row = btn.closest("tr");
      row.querySelector(".status").textContent = res.json.item.status;
    } else {
      await load();
    }
  });

  // –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
  eFiles.addEventListener("change", (e)=>{
    const picked = Array.from(e.target.files || []).filter(f=>f.type.startsWith("image/"));
    newFiles.push(...picked);
    eFiles.value = "";
    renderNewFiles();
  });

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (FormData -> /api/admin/update_upload)
  btnSave.type = "button";
  btnSave.onclick = async ()=>{
    if(!editId) { alert("–ù–µ –≤—ã–±—Ä–∞–Ω ID"); return; }
    btnSave.disabled = true; const prev = btnSave.textContent; btnSave.textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ‚Ä¶";

    try{
      const fd = new FormData();
      fd.append("id", String(editId));
      if(e_brand.value.trim())    fd.append("brand", e_brand.value.trim());
      if(e_model.value.trim())    fd.append("model", e_model.value.trim());
      if(e_year.value)            fd.append("year", String(+e_year.value));
      if(e_price.value)           fd.append("price_rub", String(+e_price.value));
      if(e_district.value.trim()) fd.append("district", e_district.value.trim());
      if(e_desc.value.trim())     fd.append("desc", e_desc.value.trim());
      fd.append("top", e_top.checked ? "1" : "0");

      // –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ (–ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏–π) —Ñ–æ—Ç–æ
      fd.append("photos_keep", existingPhotos.join(","));

      // –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã
      newFiles.forEach(f => fd.append("files", f, f.name));

      const r = await fetch("/api/admin/update_upload", {
        method: "POST",
        credentials: "include",
        body: fd
      });
      const text = await r.text();
      if(!r.ok){ alert("–û—à–∏–±–∫–∞: "+r.status+" "+text); }
      else {
        await load();
        closeEdit();
      }
    }catch(e){
      alert("–°–µ—Ç—å/—Å–∫—Ä–∏–ø—Ç: " + (e && e.message ? e.message : e));
    }finally{
      btnSave.disabled=false; btnSave.textContent=prev;
    }
  };

  btnClose.type = "button";
  btnClose.onclick = closeEdit;
  modal.addEventListener("click", (e)=>{
    if(e.target === modal) closeEdit();
  });

  btnRefresh.onclick = load;
  fStatus.onchange = load;

  load();
</script>