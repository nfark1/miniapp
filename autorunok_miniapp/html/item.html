<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>–û–±—ä—è–≤–ª–µ–Ω–∏–µ ‚Äî –ê–≤—Ç–æ—Ä—ã–Ω–æ–∫</title>
<style>
  :root{--bg:#0f0f0f;--fg:#fff;--muted:#9aa3ad;--accent:#2d82ff}
  *{box-sizing:border-box;font-family:-apple-system,system-ui,Roboto}
  body{margin:0;background:var(--bg);color:var(--fg)}
  a{text-decoration:none;color:inherit}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #1f1f1f}
  .wrap{max-width:980px;margin:0 auto;padding:12px 14px}
  .btn{background:#2d82ff;color:#fff;border:1px solid #2d82ff;border-radius:10px;padding:8px 10px;cursor:pointer}
  .btn.ghost{background:#171717;border-color:#242424;color:#ddd}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
  @media (max-width:900px){ .grid{grid-template-columns:1fr} }

  /* –≥–∞–ª–µ—Ä–µ—è */
  .gallery{background:#121212;border:1px solid #1f1f1f;border-radius:12px;padding:10px}
  .g-main{width:100%;aspect-ratio:4/3;background:#1a1a1a;border-radius:10px;background-size:cover;background-position:center}
  .thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .thumb{width:84px;height:60px;background:#1a1a1a;border:1px solid #242424;border-radius:8px;background-size:cover;background-position:center;cursor:pointer;opacity:.85}
  .thumb.active{outline:2px solid var(--accent);opacity:1}

  /* –∏–Ω—Ñ–æ */
  .card{background:#121212;border:1px solid #1f1f1f;border-radius:12px;padding:12px}
  .title{font-weight:800;font-size:20px}
  .price{font-weight:800;font-size:22px;color:#e6f0ff;margin-top:6px}
  .meta{color:var(--muted);margin-top:4px}
  .desc{margin-top:10px;color:#ddd;white-space:pre-wrap}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}

  .chip{background:#171717;border:1px solid #242424;color:#ddd;border-radius:999px;padding:6px 10px;font-size:13px}
</style>

<header>
  <div style="display:flex;gap:8px;align-items:center">
    <a class="btn ghost" href="/webapp/">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
    <div id="titleMini" style="margin-left:6px;color:#9aa3ad"></div>
  </div>
  <div style="display:flex;gap:8px;align-items:center">
    <a id="btnAdmin" class="btn ghost" style="display:none" href="#">‚úè –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
  </div>
</header>

<div class="wrap">
  <div id="msg" style="color:#9aa3ad;margin-bottom:10px">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>

  <div class="grid" id="itemGrid" style="display:none">
    <div class="gallery">
      <div id="gMain" class="g-main"></div>
      <div id="gThumbs" class="thumbs"></div>
    </div>

    <div class="card">
      <div class="title" id="tTitle"></div>
      <div class="price" id="tPrice"></div>
      <div class="meta" id="tMeta"></div>

      <div class="row" id="tChips"></div>

      <div class="desc" id="tDesc"></div>

      <div class="row" style="margin-top:14px">
        <a id="btnWrite" class="btn" target="_blank" rel="noopener">üí¨ –ù–∞–ø–∏—Å–∞—Ç—å</a>
        <button id="btnFav" class="btn ghost" type="button">‚ù§Ô∏è –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
        <!-- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å (–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–≤–µ—Ä—Ö—É) —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∞–¥–º–∏–Ω -->
        <a id="btnAdmin2" class="btn ghost" style="display:none" href="#">‚úè –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
      </div>
    </div>
  </div>
</div>

<script>
  // --- utils ---
  function qs(p){ return new URLSearchParams(location.search).get(p); }
  function fmtPrice(n){ return (typeof n==="number") ? n.toLocaleString("ru-RU")+" ‚ÇΩ" : ""; }
  function el(html){ const d=document.createElement("div"); d.innerHTML=html.trim(); return d.firstChild; }

  // –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
  const FAV_KEY = "fav_ids";
  const readFav = ()=> new Set(JSON.parse(localStorage.getItem(FAV_KEY)||"[]"));
  const writeFav = (s)=> localStorage.setItem(FAV_KEY, JSON.stringify([...s]));

  // --- API ---
  async function apiMe(){
    const r = await fetch("/api/me",{credentials:"include"});
    if(!r.ok) return null; return r.json();
  }
  async function apiItem(id){
    const r = await fetch(`/api/listing/${id}`, {credentials:"include"});
    if(!r.ok) return null; return r.json();
  }

  // --- render ---
  function renderGallery(urls){
    const main = document.getElementById("gMain");
    const thumbs = document.getElementById("gThumbs");
    thumbs.innerHTML = "";
    if(!urls || !urls.length){
      main.style.backgroundImage = "";
      return;
    }
    let active = 0;
    main.style.backgroundImage = `url('${urls[0]}')`;
    urls.forEach((u, idx)=>{
      const th = document.createElement("div");
      th.className = "thumb" + (idx===0 ? " active" : "");
      th.style.backgroundImage = `url('${u}')`;
      th.onclick = ()=>{
        active = idx;
        main.style.backgroundImage = `url('${urls[active]}')`;
        Array.from(thumbs.children).forEach(ch=>ch.classList.remove("active"));
        th.classList.add("active");
      };
      thumbs.appendChild(th);
    });
  }

  function mountAdminButtons(isAdmin, id){
    const a1 = document.getElementById("btnAdmin");
    const a2 = document.getElementById("btnAdmin2");
    if(isAdmin){
      const href = `/webapp/admin?open=${id}`;
      a1.href = href; a1.style.display = "inline-block";
      a2.href = href; a2.style.display = "inline-block";
    } else {
      a1.style.display = "none";
      a2.style.display = "none";
    }
  }

  (async ()=>{
    const id = location.pathname.split("/").pop();
    const me = await apiMe().catch(()=>null);
    const data = await apiItem(id);

    const msg = document.getElementById("msg");
    const grid = document.getElementById("itemGrid");

    if(!data || !data.item){
      msg.textContent = "–û–±—ä—è–≤–ª–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ";
      return;
    }
    const it = data.item;

    // –∑–∞–≥–æ–ª–æ–≤–∫–∏/—Ü–µ–Ω–∞/–º–µ—Ç–∞
    document.getElementById("titleMini").textContent = `${it.brand} ${it.model} ${it.year||""}`.trim();
    document.getElementById("tTitle").textContent = `${it.brand} ${it.model}, ${it.year}`;
    document.getElementById("tPrice").textContent = fmtPrice(it.price_rub);
    document.getElementById("tMeta").textContent = `üìç ${it.district || "‚Äî"} ‚Ä¢ –°—Ç–∞—Ç—É—Å: ${it.status || "‚Äî"}`;

    // —á–∏–ø—ã (–¢–û–ü, –≤–ª–∞–¥–µ–ª–µ—Ü –∏ —Ç.–ø.)
    const chips = document.getElementById("tChips");
    chips.innerHTML = "";
    if(it.top) chips.appendChild(el(`<span class="chip">–¢–û–ü</span>`));
    chips.appendChild(el(`<span class="chip">${it.brand}</span>`));
    chips.appendChild(el(`<span class="chip">${it.model}</span>`));
    if(it.year) chips.appendChild(el(`<span class="chip">${it.year}</span>`));

    // –æ–ø–∏—Å–∞–Ω–∏–µ
    document.getElementById("tDesc").textContent = it.desc || "";

    // –∫–æ–Ω—Ç–∞–∫—Ç—ã
    const btnWrite = document.getElementById("btnWrite");
    if(it.owner_username){
      btnWrite.href = `https://t.me/${it.owner_username}`;
      btnWrite.removeAttribute("disabled");
    } else {
      btnWrite.href = "#";
      btnWrite.setAttribute("disabled", "true");
      btnWrite.textContent = "–õ–æ–≥–∏–Ω –∞–≤—Ç–æ—Ä–∞ –Ω–µ —É–∫–∞–∑–∞–Ω";
    }

    // –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
    const favBtn = document.getElementById("btnFav");
    const fav = readFav();
    const on = fav.has(+it.id);
    if(on){ favBtn.classList.remove("ghost"); favBtn.textContent = "üíô –í –∏–∑–±—Ä–∞–Ω–Ω–æ–º"; }
    favBtn.onclick = ()=>{
      const cur = readFav();
      if(cur.has(+it.id)){ cur.delete(+it.id); favBtn.classList.add("ghost"); favBtn.textContent = "‚ù§Ô∏è –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ"; }
      else { cur.add(+it.id); favBtn.classList.remove("ghost"); favBtn.textContent = "üíô –í –∏–∑–±—Ä–∞–Ω–Ω–æ–º"; }
      writeFav(cur);
    };

    // –≥–∞–ª–µ—Ä–µ—è
    renderGallery(it.photos || []);

    // –∞–¥–º–∏–Ω-–∫–Ω–æ–ø–∫–∏
    mountAdminButtons(!!(me && me.is_admin), it.id);

    // –ø–æ–∫–∞–∑–∞—Ç—å
    msg.remove?.();
    grid.style.display = "grid";
  })();
</script>