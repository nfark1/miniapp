<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Профиль — Локально</title>
<style>
  body{margin:0;background:#0f0f0f;color:#fff;font:14px/1.5 -apple-system,system-ui,Roboto}
  .wrap{max-width:720px;margin:0 auto;padding:16px}
  .card{background:#121212;border:1px solid #1f1f1f;border-radius:12px;padding:16px}
  label{display:block;color:#9aa3ad;margin:8px 0 4px}
  input{width:100%;background:#171717;border:1px solid #242424;color:#fff;border-radius:10px;padding:10px}
  .row{display:flex;gap:12px;align-items:center}
  .switch{display:flex;gap:8px;align-items:center}
  .btn{background:#2d82ff;border:none;color:#fff;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:700}
  .msg{margin-top:10px;color:#9aa3ad}
  a{color:#9ab9ff}
</style>
<div class="wrap">
  <h2>Профиль</h2>
  <div class="card">
    <div class="row">
      <div style="flex:1">
        <label>Имя</label>
        <input id="first_name" placeholder="Имя">
      </div>
      <div style="flex:1">
        <label>Фамилия</label>
        <input id="last_name" placeholder="Фамилия">
      </div>
    </div>

    <label>Логин Telegram (только чтение)</label>
    <input id="username" disabled>

    <label>Телефон (для связи с вами)</label>
    <input id="phone" placeholder="+7...">

    <div class="switch" style="margin-top:10px">
      <input id="dealer" type="checkbox">
      <label for="dealer">Я — продавец/перекуп, хочу публиковать объявления</label>
    </div>

    <div class="row" style="margin-top:12px">
      <button id="save" class="btn">Сохранить</button>
      <div id="msg" class="msg"></div>
    </div>
  </div>

  <div style="margin-top:12px"><a href="/webapp/">← На главную</a></div>
</div>
<script>
  async function apiGet(url){ const r=await fetch(url,{credentials:"include"}); return r.ok? r.json():null; }
  async function apiPost(url,data){
    const r = await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(data)});
    return {ok:r.ok, status:r.status, text: await r.text()};
  }

  (async ()=>{
    const me = await apiGet("/api/me");
    const msg = document.getElementById("msg");
    if(!me){ msg.textContent="Не залогинен"; return; }

    // заполняем форму
    document.getElementById("first_name").value = me.first_name||"";
    document.getElementById("last_name").value  = me.last_name||"";
    document.getElementById("username").value   = me.username ? "@"+me.username : "";
    document.getElementById("phone").value      = me.phone||"";
    document.getElementById("dealer").checked   = !!me.dealer;

    document.getElementById("save").onclick = async ()=>{
      msg.textContent="Сохраняю...";
      const data = {
        first_name: document.getElementById("first_name").value.trim(),
        last_name:  document.getElementById("last_name").value.trim(),
        phone:      document.getElementById("phone").value.trim(),
        dealer:     document.getElementById("dealer").checked ? 1 : 0
      };
      const res = await apiPost("/api/profile", data);
      msg.textContent = res.ok? "Сохранено": ("Ошибка: "+res.status+" "+res.text);
    };
  })();
</script>